<!DOCTYPE html><html lang="en"><head><title>src/test.q.shf</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/test.q.shf"><meta name="groc-project-path" content="src/test.q.shf.c"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/test.q.shf.c</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/*</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> * Copyright (c) 2014 Hardy-Francis Enterprises Inc.</span>
<span class="cm"> * This file is part of SharedHashFile.</span>
<span class="cm"> *</span>
<span class="cm"> * SharedHashFile is free software: you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU Affero General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * SharedHashFile is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public</span>
<span class="cm"> * License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Affero General Public License</span>
<span class="cm"> * along with this program. If not, see www.gnu.org/licenses/.</span>
<span class="cm"> * ----------------------------------------------------------------------------</span>
<span class="cm"> * To use SharedHashFile in a closed-source product, commercial licenses are</span>
<span class="cm"> * available; email office [@] sharedhashfile [.] com for more information.</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> */</span>

<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;stdint.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;        </span><span class="cm">/* for printf() */</span><span class="cp"></span>
<span class="cp">#include &lt;sys/types.h&gt;    </span><span class="cm">/* for getpid() */</span><span class="cp"></span>
<span class="cp">#include &lt;sys/wait.h&gt;     </span><span class="cm">/* for waitpid() */</span><span class="cp"></span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;linux/limits.h&gt; </span><span class="cm">/* for PATH_MAX */</span><span class="cp"></span>
<span class="cp">#include &lt;errno.h&gt;        </span><span class="cm">/* for errno */</span><span class="cp"></span>
<span class="cp">#include &lt;stdlib.h&gt;       </span><span class="cm">/* for exit() */</span><span class="cp"></span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;sys/un.h&gt;       </span><span class="cm">/* for struct sockaddr_un */</span><span class="cp"></span>
<span class="cp">#include &lt;sys/time.h&gt;     </span><span class="cm">/* for gettimeofday() */</span><span class="cp"></span>
<span class="cp">#include &lt;string.h&gt;       </span><span class="cm">/* for memset() */</span><span class="cp"></span>
<span class="cp">#include &lt;locale.h&gt;       </span><span class="cm">/* for setlocale() */</span><span class="cp"></span>

<span class="cp">#include &lt;shf.private.h&gt;</span>
<span class="cp">#include &lt;shf.h&gt;</span>
<span class="cp">#include &quot;tap.h&quot;</span>

<span class="k">static</span> <span class="kt">double</span>
<span class="nf">test_dummy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* test_dummy() */</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">setlocale</span><span class="p">(</span><span class="n">LC_NUMERIC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="s">&quot;setlocale(): %u: &quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SHF_ASSERT</span><span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2js&quot;</span><span class="p">)))</span>
        <span class="o">||</span>         <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2c&quot;</span> <span class="p">)))</span>
        <span class="o">||</span>         <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;4c&quot;</span>  <span class="p">))),</span> <span class="s">&quot;ERROR: please supply an argument; c2js, c2py, c2c, or 4c; got: &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2js&quot;</span><span class="p">)))</span> <span class="p">{</span> <span class="n">plan_tests</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2py&quot;</span><span class="p">)))</span> <span class="p">{</span> <span class="n">plan_tests</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2c&quot;</span> <span class="p">)))</span> <span class="p">{</span> <span class="n">plan_tests</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;4c&quot;</span>  <span class="p">)))</span> <span class="p">{</span> <span class="n">plan_tests</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">else</span>                                                                       <span class="p">{</span> <span class="n">plan_tests</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;c2c&quot;</span>          <span class="p">;</span> <span class="p">}</span> <span class="cm">/* default if no arguments */</span>

    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
    <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;pid %u started; mode is &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2js&quot;</span><span class="p">)))</span> <span class="p">{</span> <span class="cm">/* just for fun, test C to C call speed; useful for comparing to V8 to C call speed */</span>
        <span class="kt">double</span> <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">test_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">test_iterations</span> <span class="o">+=</span> <span class="n">test_dummy</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_iterations</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;   c2*: called  expected number to dummy function  // estimate %&#39;.0f calls per second&quot;</span><span class="p">,</span> <span class="n">test_iterations</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">char</span>  <span class="n">test_shf_name</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span>  <span class="n">test_shf_folder</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;/dev/shm&quot;</span><span class="p">;</span>
    <span class="n">SHF_SNPRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_shf_name</span><span class="p">,</span> <span class="s">&quot;test-%05u-ipc-queue&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

    <span class="n">SHF</span>      <span class="o">*</span> <span class="n">shf</span><span class="p">;</span>
    <span class="kt">uint32_t</span>   <span class="n">uid</span><span class="p">;</span>
    <span class="kt">uint32_t</span>   <span class="n">test_keys</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;4c&quot;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;&#39;4c&#39; mode; behaving as client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ERROR: please supply arguments; 4c &lt;name of shf&gt;&quot;</span><span class="p">);</span>

              <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>
              <span class="n">shf_init</span>                <span class="p">();</span>
        <span class="n">shf</span> <span class="o">=</span> <span class="n">shf_attach_existing</span>     <span class="p">(</span><span class="n">test_shf_folder</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="n">ok</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">shf</span><span class="p">,</span> <span class="s">&quot;    4c: shf_attach_existing() works for existing file as expected&quot;</span><span class="p">);</span>

        <span class="kt">char</span>     <span class="o">*</span> <span class="n">test_q_items_addr</span>  <span class="o">=</span> <span class="n">shf_q_get</span><span class="p">(</span><span class="n">shf</span><span class="p">);</span> <span class="n">SHF_UNUSE</span><span class="p">(</span><span class="n">test_q_items_addr</span><span class="p">);</span> <span class="cm">/* todo: this test doesn&#39;t actually manipulate the item itself */</span>
        <span class="kt">uint32_t</span>   <span class="n">test_qid_free</span>      <span class="o">=</span> <span class="n">shf_q_get_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-free&quot;</span><span class="p">));</span>
        <span class="kt">uint32_t</span>   <span class="n">test_qid_a2b</span>       <span class="o">=</span> <span class="n">shf_q_get_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-a2b&quot;</span> <span class="p">));</span>
        <span class="kt">uint32_t</span>   <span class="n">test_qid_b2a</span>       <span class="o">=</span> <span class="n">shf_q_get_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-b2a&quot;</span> <span class="p">));</span>
        <span class="n">ok</span><span class="p">(</span>        <span class="n">test_qid_free</span>     <span class="o">!=</span> <span class="n">SHF_QID_NONE</span><span class="p">,</span> <span class="s">&quot;    4c: shf_q_get_name(&#39;qid-free&#39;) returned qid as expected&quot;</span><span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span>        <span class="n">test_qid_a2b</span>      <span class="o">!=</span> <span class="n">SHF_QID_NONE</span><span class="p">,</span> <span class="s">&quot;    4c: shf_q_get_name(&#39;qid-a2b&#39; ) returned qid as expected&quot;</span><span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span>        <span class="n">test_qid_b2a</span>      <span class="o">!=</span> <span class="n">SHF_QID_NONE</span><span class="p">,</span> <span class="s">&quot;    4c: shf_q_get_name(&#39;qid-b2a&#39; ) returned qid as expected&quot;</span><span class="p">);</span>

        <span class="n">shf_race_start</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-q-race-line&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">shf_debug_verbosity_more</span><span class="p">();</span> <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;testing process b IPC queue a2b --&gt; b2a speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>
        <span class="p">{</span>
            <span class="kt">uint32_t</span> <span class="n">test_pull_items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">double</span>   <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
            <span class="n">shf_qiid</span> <span class="o">=</span> <span class="n">SHF_QIID_NONE</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf_q_push_head_pull_tail</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qid_b2a</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">,</span> <span class="n">test_qid_a2b</span><span class="p">))</span> <span class="p">{</span>
                                       <span class="n">test_pull_items</span> <span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">test_pull_items</span> <span class="o">&gt;=</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span> <span class="k">goto</span> <span class="n">FINISH_LINE_4C</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>
<span class="nl">FINISH_LINE_4C:</span><span class="p">;</span>
            <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
            <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;    4c: moved   expected number of new queue items // estimate %&#39;.0f q items per second with contention&quot;</span><span class="p">,</span> <span class="n">test_pull_items</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">{</span>
            <span class="n">shf_debug_verbosity_more</span><span class="p">();</span> <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;testing process b IPC lock speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>

                                    <span class="n">SHF_MAKE_HASH</span>       <span class="p">(</span><span class="s">&quot;lock&quot;</span><span class="p">);</span>
            <span class="n">SHF_LOCK</span> <span class="o">*</span> <span class="n">lock</span>  <span class="o">=</span>      <span class="n">shf_get_key_val_addr</span><span class="p">(</span><span class="n">shf</span>   <span class="p">);</span>
            <span class="n">ok</span><span class="p">(</span>        <span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span>                             <span class="p">,</span> <span class="s">&quot;    4c: got lock value address as expected&quot;</span><span class="p">);</span>

            <span class="n">shf_race_start</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-lock-race-line&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
            <span class="kt">double</span> <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
            <span class="kt">double</span> <span class="n">test_lock_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="n">SHF_LOCK_WRITER</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
                <span class="n">SHF_UNLOCK_WRITER</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
                <span class="n">test_lock_iterations</span> <span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_lock_iterations</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">);</span>
            <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
            <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;    4c: rw lock expected number of times           // estimate %&#39;.0f locks per second; with contention&quot;</span><span class="p">,</span> <span class="n">test_lock_iterations</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">shf_detach</span><span class="p">(</span><span class="n">shf</span><span class="p">);</span>

        <span class="k">goto</span> <span class="n">EARLY_OUT</span><span class="p">;</span>
    <span class="p">}</span> <span class="cm">/* 4c */</span>

          <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>
          <span class="n">shf_init</span>                <span class="p">();</span>
          <span class="n">shf_set_data_need_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">shf</span> <span class="o">=</span> <span class="n">shf_attach</span>              <span class="p">(</span><span class="n">test_shf_folder</span><span class="p">,</span> <span class="n">test_shf_name</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* delete upon process exit */</span><span class="p">);</span> <span class="n">ok</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">shf</span><span class="p">,</span> <span class="s">&quot;   c2*: shf_attach()          works for non-existing file as expected&quot;</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="n">shf_race_init</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-q-race-line&quot;</span>   <span class="p">));</span>
        <span class="n">shf_race_init</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-lock-race-line&quot;</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2c&quot;</span><span class="p">)))</span> <span class="p">{</span>
                      <span class="n">SHF_MAKE_HASH</span>  <span class="p">(</span>                     <span class="s">&quot;lock&quot;</span><span class="p">);</span>
               <span class="n">uid</span> <span class="o">=</span>  <span class="n">shf_put_key_val</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SHF_LOCK</span><span class="p">));</span>
            <span class="n">ok</span><span class="p">(</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">SHF_UID_NONE</span>                                <span class="p">,</span> <span class="s">&quot;   c2*: put lock in value as expected&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">uint32_t</span> <span class="n">test_qs</span>          <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">test_q_items</span>     <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">test_q_item_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="nb">NULL</span>            <span class="o">!=</span> <span class="n">shf_q_new</span>     <span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qs</span><span class="p">,</span> <span class="n">test_q_items</span><span class="p">,</span> <span class="n">test_q_item_size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="s">&quot;   c2*: shf_q_new() returned as expected&quot;</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">test_qid_free</span>    <span class="o">=</span> <span class="n">shf_q_new_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-free&quot;</span><span class="p">)</span>           <span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">test_qid_a2b</span>     <span class="o">=</span> <span class="n">shf_q_new_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-a2b&quot;</span> <span class="p">)</span>           <span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">test_qid_b2a</span>     <span class="o">=</span> <span class="n">shf_q_new_name</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-b2a&quot;</span> <span class="p">)</span>           <span class="p">);</span>

    <span class="p">{</span>
        <span class="kt">double</span>   <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">uint32_t</span> <span class="n">test_pull_items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf_q_pull_tail</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qid_free</span>          <span class="p">))</span> <span class="p">{</span>
                               <span class="n">shf_q_push_head</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qid_a2b</span> <span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                               <span class="n">test_pull_items</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">test_q_items</span> <span class="o">==</span> <span class="n">test_pull_items</span><span class="p">,</span> <span class="s">&quot;   c2*: moved   expected number of new queue items // estimate %&#39;.0f q items per second without contention&quot;</span><span class="p">,</span> <span class="n">test_keys</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">pid_t</span> <span class="n">child_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span>      <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2js&quot;</span><span class="p">)))</span> <span class="p">{</span> <span class="n">child_pid</span> <span class="o">=</span> <span class="n">shf_exec_child</span><span class="p">(</span><span class="n">shf_backticks</span><span class="p">(</span><span class="s">&quot;which node || which nodejs&quot;</span><span class="p">),</span> <span class="n">shf_backticks</span><span class="p">(</span><span class="s">&quot;which node || which nodejs&quot;</span><span class="p">),</span> <span class="s">&quot;TestIpcQueue.js&quot;</span><span class="p">,</span> <span class="n">test_shf_name</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2py&quot;</span><span class="p">)))</span> <span class="p">{</span> <span class="n">child_pid</span> <span class="o">=</span> <span class="n">shf_exec_child</span><span class="p">(</span><span class="n">shf_backticks</span><span class="p">(</span><span class="s">&quot;which python&quot;</span>              <span class="p">),</span> <span class="s">&quot;python&quot;</span>                                   <span class="p">,</span> <span class="s">&quot;TestIpcQueue.py&quot;</span><span class="p">,</span> <span class="n">test_shf_name</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2c&quot;</span> <span class="p">)))</span> <span class="p">{</span> <span class="n">child_pid</span> <span class="o">=</span> <span class="n">shf_exec_child</span><span class="p">(</span><span class="n">shf_backticks</span><span class="p">(</span><span class="s">&quot;which test.q.shf.t&quot;</span>        <span class="p">),</span> <span class="s">&quot;test.q.shf.t&quot;</span>                             <span class="p">,</span> <span class="s">&quot;4c&quot;</span>             <span class="p">,</span> <span class="n">test_shf_name</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span>                                                           <span class="p">{</span> <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ERROR: should never get here!&quot;</span><span class="p">);</span> <span class="p">}</span>

    <span class="n">shf_race_start</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-q-race-line&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">shf_debug_verbosity_more</span><span class="p">();</span> <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;testing process a IPC queue b2a --&gt; a2b speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>
    <span class="p">{</span>
        <span class="kt">double</span>   <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">uint32_t</span> <span class="n">test_pull_items</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">shf_qiid</span> <span class="o">=</span> <span class="n">SHF_QIID_NONE</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf_q_push_head_pull_tail</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qid_a2b</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">,</span> <span class="n">test_qid_b2a</span><span class="p">))</span> <span class="p">{</span>
                                   <span class="n">test_pull_items</span> <span class="o">++</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">1000000</span>     <span class="o">==</span> <span class="n">test_pull_items</span><span class="p">)</span> <span class="p">{</span> <span class="n">shf_q_push_head_pull_tail</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">test_qid_a2b</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">,</span> <span class="n">test_qid_b2a</span><span class="p">);</span> <span class="k">goto</span> <span class="n">FINISH_LINE_C2</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2js&quot;</span><span class="p">)))</span>
            <span class="o">||</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2py&quot;</span><span class="p">))))</span> <span class="p">{</span> <span class="cm">/* the rw spin locks are fair but don&#39;t create unnecessary contention for javascript or python client */</span>
                <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* 1/1000th of a second */</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="nl">FINISH_LINE_C2:</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">usleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span> <span class="cm">/* hack: wait 3/1000th of a second so that the oks do not conflict */</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;   c2*: moved   expected number of new queue items // estimate %&#39;.0f q items per second with contention&quot;</span><span class="p">,</span> <span class="n">test_pull_items</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;c2c&quot;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">shf_debug_verbosity_more</span><span class="p">();</span> <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;testing process a IPC lock speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">shf_debug_verbosity_less</span><span class="p">();</span>

                                <span class="n">SHF_MAKE_HASH</span>       <span class="p">(</span><span class="s">&quot;lock&quot;</span><span class="p">);</span>
        <span class="n">SHF_LOCK</span> <span class="o">*</span> <span class="n">lock</span>  <span class="o">=</span>      <span class="n">shf_get_key_val_addr</span><span class="p">(</span><span class="n">shf</span>   <span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span>        <span class="n">lock</span> <span class="o">!=</span> <span class="nb">NULL</span>                             <span class="p">,</span> <span class="s">&quot;   c2*: got lock value address as expected&quot;</span><span class="p">);</span>

        <span class="n">shf_race_start</span><span class="p">(</span><span class="n">shf</span><span class="p">,</span> <span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;test-lock-race-line&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">test_lock_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">SHF_LOCK_WRITER</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">SHF_UNLOCK_WRITER</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">test_lock_iterations</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_lock_iterations</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;   c2*: rw lock expected number of times           // estimate %&#39;.0f locks per second; with contention&quot;</span><span class="p">,</span> <span class="n">test_lock_iterations</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>

        <span class="n">SHF_LOCK</span> <span class="n">lock_without_contention</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_without_contention</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lock_without_contention</span><span class="p">));</span>
        <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="n">test_lock_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">SHF_LOCK_WRITER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_without_contention</span><span class="p">);</span>
            <span class="n">SHF_UNLOCK_WRITER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_without_contention</span><span class="p">);</span>
            <span class="n">test_lock_iterations</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_lock_iterations</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">);</span>
        <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;   c2*: rw lock expected number of times           // estimate %&#39;.0f locks per second; without contention&quot;</span><span class="p">,</span> <span class="n">test_lock_iterations</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>

        <span class="n">test_start_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="n">test_lock_iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">test_lock_iterations</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_lock_iterations</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">);</span>
        <span class="n">test_elapsed_time</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_start_time</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;   c2*: rw lock expected number of times           // estimate %&#39;.0f locks per second; without lock&quot;</span><span class="p">,</span> <span class="n">test_lock_iterations</span> <span class="o">/</span> <span class="n">test_elapsed_time</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">shf_debug_verbosity_more</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">waitpid</span><span class="p">(</span><span class="n">child_pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;test: shf size before deletion: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shf_del</span><span class="p">(</span><span class="n">shf</span><span class="p">));</span>

<span class="nl">EARLY_OUT:</span><span class="p">;</span>

    <span class="n">SHF_DEBUG</span><span class="p">(</span><span class="s">&quot;ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">exit_status</span><span class="p">();</span>
<span class="p">}</span> <span class="cm">/* main() */</span></div></div></div></div></body></html>