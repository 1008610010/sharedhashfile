<!DOCTYPE html><html lang="en"><head><title>src/test.a.shf</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/test.a.shf"><meta name="groc-project-path" content="src/test.a.shf.cpp"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/test.a.shf.cpp</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/*</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> * Copyright (c) 2014 Hardy-Francis Enterprises Inc.</span>
<span class="cm"> * This file is part of SharedHashFile.</span>
<span class="cm"> *</span>
<span class="cm"> * SharedHashFile is free software: you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU Affero General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * SharedHashFile is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public</span>
<span class="cm"> * License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Affero General Public License</span>
<span class="cm"> * along with this program. If not, see www.gnu.org/licenses/.</span>
<span class="cm"> * ----------------------------------------------------------------------------</span>
<span class="cm"> * To use SharedHashFile in a closed-source product, commercial licenses are</span>
<span class="cm"> * available; email office [@] sharedhashfile [.] com for more information.</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#include &lt;string.h&gt; </span><span class="cm">/* for memcmp() */</span><span class="cp"></span>
<span class="cp">#include &lt;locale.h&gt; </span><span class="cm">/* for setlocale() */</span><span class="cp"></span>

<span class="cp">#include &lt;tap.h&gt;</span>
<span class="cp">#include &lt;shf.defines.h&gt;</span>
<span class="p">}</span>

<span class="cp">#include &lt;SharedHashFile.hpp&gt;</span>

<span class="kt">int</span>
<span class="n">main</span><span class="p">(</span><span class="cm">/* int argc,char **argv */</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">plan_tests</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>

    <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">setlocale</span><span class="p">(</span><span class="n">LC_NUMERIC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="s">&quot;setlocale(): %u: &quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>

    <span class="kt">char</span>  <span class="n">testShfName</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span>  <span class="n">testShfFolder</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;/dev/shm&quot;</span><span class="p">;</span>
    <span class="kt">pid_t</span> <span class="n">pid</span>             <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
    <span class="n">SHF_SNPRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">testShfName</span><span class="p">,</span> <span class="s">&quot;test-%05u&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

    <span class="n">SharedHashFile</span> <span class="o">*</span> <span class="n">shf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SharedHashFile</span><span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span>              <span class="n">shf</span>                                                    <span class="p">,</span> <span class="s">&quot;c++: new SharedHashFile returned object as expected&quot;</span>            <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">IsAttached</span>    <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;IsAttached()               not attached      as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">AttachExisting</span><span class="p">(</span><span class="n">testShfFolder</span><span class="p">,</span> <span class="n">testShfName</span>        <span class="p">),</span> <span class="s">&quot;c++: -&gt;AttachExisting() fails for non-existing file as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">IsAttached</span>    <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;IsAttached()               not attached      as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">Attach</span>        <span class="p">(</span><span class="n">testShfFolder</span><span class="p">,</span> <span class="n">testShfName</span><span class="p">,</span> <span class="mi">1</span>     <span class="p">),</span> <span class="s">&quot;c++: -&gt;Attach()         works for non-existing file as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">IsAttached</span>    <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;IsAttached()                   attached      as expected&quot;</span><span class="p">);</span>
                     <span class="n">shf</span><span class="o">-&gt;</span><span class="n">SetIsLockable</span> <span class="p">(</span><span class="mi">0</span>                                 <span class="p">);</span> <span class="cm">/* single threaded test; no need to lock */</span>
                     <span class="n">shf</span><span class="o">-&gt;</span><span class="n">MakeHash</span>      <span class="p">(</span>         <span class="s">&quot;key&quot;</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                                                                    <span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetKeyValCopy</span> <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;GetKeyValCopy() could not find unput key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DelKeyVal</span>     <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;DelKeyVal()     could not find unput key as expected&quot;</span>    <span class="p">);</span>
    <span class="kt">uint32_t</span>  <span class="n">uid</span> <span class="o">=</span>  <span class="n">shf</span><span class="o">-&gt;</span><span class="n">PutKeyVal</span>     <span class="p">(</span>         <span class="s">&quot;val&quot;</span> <span class="p">,</span> <span class="mi">3</span>                <span class="p">)</span>                                                                    <span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span>       <span class="n">uid</span> <span class="o">!=</span> <span class="n">SHF_UID_NONE</span>                                           <span class="p">,</span> <span class="s">&quot;c++: -&gt;PutKeyVal()                      put key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetKeyValCopy</span> <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;GetKeyValCopy() could     find   put key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">3</span>          <span class="o">==</span> <span class="n">shf_val_len</span>                                            <span class="p">,</span> <span class="s">&quot;c++: shf_val_len                                as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">memcmp</span>             <span class="p">(</span><span class="n">shf_val</span><span class="p">,</span> <span class="s">&quot;val&quot;</span> <span class="p">,</span> <span class="mi">3</span>                <span class="p">),</span> <span class="s">&quot;c++: shf_val                                    as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DelUidVal</span>     <span class="p">(</span><span class="n">uid</span>                               <span class="p">),</span> <span class="s">&quot;c++: -&gt;DelUidVal()     could     find   put key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetKeyValCopy</span> <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;GetKeyValCopy() could not find   del key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DelUidVal</span>     <span class="p">(</span><span class="n">uid</span>                               <span class="p">),</span> <span class="s">&quot;c++: -&gt;DelUidVal()     could not find   del key as expected&quot;</span>    <span class="p">);</span>
              <span class="n">uid</span> <span class="o">=</span>  <span class="n">shf</span><span class="o">-&gt;</span><span class="n">PutKeyVal</span>     <span class="p">(</span>         <span class="s">&quot;val2&quot;</span><span class="p">,</span> <span class="mi">4</span>                <span class="p">)</span>                                                                    <span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span>       <span class="n">uid</span> <span class="o">!=</span> <span class="n">SHF_UID_NONE</span>                                           <span class="p">,</span> <span class="s">&quot;c++: -&gt;PutKeyVal()                    reput key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetUidValCopy</span> <span class="p">(</span><span class="n">uid</span>                               <span class="p">),</span> <span class="s">&quot;c++: -&gt;GetUidValCopy() could     find reput key as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">4</span>          <span class="o">==</span> <span class="n">shf_val_len</span>                                            <span class="p">,</span> <span class="s">&quot;c++: shf_val_len                                as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span>          <span class="o">==</span> <span class="n">memcmp</span>             <span class="p">(</span><span class="n">shf_val</span><span class="p">,</span> <span class="s">&quot;val2&quot;</span><span class="p">,</span> <span class="mi">4</span>                <span class="p">),</span> <span class="s">&quot;c++: shf_val                                    as expected&quot;</span>    <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span>          <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DelKeyVal</span>     <span class="p">(</span>                                  <span class="p">),</span> <span class="s">&quot;c++: -&gt;DelKeyVal()     could     find reput key as expected&quot;</span>    <span class="p">);</span>

    <span class="kt">uint32_t</span> <span class="n">testPullItems</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">testQs</span>         <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">testQItems</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">testQItemSize</span>  <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="mi">0</span>             <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QIsReady</span><span class="p">(</span>                                    <span class="p">),</span> <span class="s">&quot;c++: -&gt;QIsReady() not ready as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="nb">NULL</span>          <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QNew</span>    <span class="p">(</span><span class="n">testQs</span><span class="p">,</span> <span class="n">testQItems</span><span class="p">,</span> <span class="n">testQItemSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;c++: -&gt;QNew()     returned  as expected&quot;</span><span class="p">);</span>              <span class="cm">/* e.g. q items created  by process a */</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="mi">1</span>             <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QIsReady</span><span class="p">(</span>                                    <span class="p">),</span> <span class="s">&quot;c++: -&gt;QIsReady()     ready as expected&quot;</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">testQidFree</span>    <span class="o">=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QNewName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-free&quot;</span><span class="p">)</span>  <span class="p">);</span>                                                          <span class="cm">/* e.g. q names set qids by process a */</span>
    <span class="kt">uint32_t</span> <span class="n">testQidA2b</span>     <span class="o">=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QNewName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-a2b&quot;</span> <span class="p">)</span>  <span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">testQidB2a</span>     <span class="o">=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QNewName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-b2a&quot;</span> <span class="p">)</span>  <span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="n">testQidFree</span>   <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QGetName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-free&quot;</span><span class="p">)</span>  <span class="p">),</span> <span class="s">&quot;c++: -&gt;QGetName(&#39;qid-free&#39;) returned qid as expected&quot;</span><span class="p">);</span> <span class="cm">/* e.g. q names get qids by process b */</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="n">testQidA2b</span>    <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QGetName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-a2b&quot;</span> <span class="p">)</span>  <span class="p">),</span> <span class="s">&quot;c++: -&gt;QGetName(&#39;qid-a2b&#39; ) returned qid as expected&quot;</span><span class="p">);</span>
    <span class="n">ok</span><span class="p">(</span>      <span class="n">testQidB2a</span>    <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QGetName</span><span class="p">(</span><span class="n">SHF_CONST_STR_AND_SIZE</span><span class="p">(</span><span class="s">&quot;qid-b2a&quot;</span> <span class="p">)</span>  <span class="p">),</span> <span class="s">&quot;c++: -&gt;QGetName(&#39;qid-b2a&#39; ) returned qid as expected&quot;</span><span class="p">);</span>

    <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPullTail</span><span class="p">(</span><span class="n">testQidFree</span>          <span class="p">))</span> <span class="p">{</span>                                                                       <span class="cm">/* e.g. q items from unused to a2b q by process a */</span>
                           <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHead</span><span class="p">(</span><span class="n">testQidA2b</span> <span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                           <span class="n">SHF_CAST</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">shf_qiid_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">testPullItems</span><span class="p">;</span> <span class="cm">/* store q item # in item */</span>
                           <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: pulled &amp; pushed items from free to a2b  as expected&quot;</span><span class="p">);</span>

    <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPullTail</span><span class="p">(</span><span class="n">testQidA2b</span>          <span class="p">))</span> <span class="p">{</span>                                                                        <span class="cm">/* e.g. q items from a2b to b2a queue by process b */</span>
                           <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHead</span><span class="p">(</span><span class="n">testQidB2a</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                           <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="n">testPullItems</span> <span class="o">==</span> <span class="n">SHF_CAST</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">shf_qiid_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;INTERNAL: test expected q item %u but got %u&quot;</span><span class="p">,</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="n">SHF_CAST</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">shf_qiid_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
                           <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: pulled &amp; pushed items from a2b  to b2a  as expected&quot;</span><span class="p">);</span>

    <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPullTail</span><span class="p">(</span><span class="n">testQidB2a</span>           <span class="p">))</span> <span class="p">{</span>                                                                       <span class="cm">/* e.g. q items from b2a to free queue by process a */</span>
                           <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHead</span><span class="p">(</span><span class="n">testQidFree</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                           <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="n">testPullItems</span> <span class="o">==</span> <span class="n">SHF_CAST</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">shf_qiid_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;INTERNAL: test expected q item %u but got %u&quot;</span><span class="p">,</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="n">SHF_CAST</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">shf_qiid_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
                           <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: pulled &amp; pushed items from a2b  to free as expected&quot;</span><span class="p">);</span>

    <span class="kt">uint32_t</span> <span class="n">testKeys</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
    <span class="n">shf</span><span class="o">-&gt;</span><span class="n">SetDataNeedFactor</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="n">SHF_SNPRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="s">&quot;ps -o rss -p %u | perl -lane &#39;print if(m~[0-9]~);&#39;&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="kt">int32_t</span> <span class="n">rss_size_before</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">shf_backticks</span><span class="p">(</span><span class="n">command</span><span class="p">));</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testKeys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">shf</span><span class="o">-&gt;</span><span class="n">MakeHash</span> <span class="p">(</span><span class="n">SHF_CAST</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">shf</span><span class="o">-&gt;</span><span class="n">PutKeyVal</span><span class="p">(</span><span class="n">SHF_CAST</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="kt">int32_t</span> <span class="n">rss_size_after</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">shf_backticks</span><span class="p">(</span><span class="n">command</span><span class="p">));</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;c++: put expected number of              keys // estimate %&#39;.0f keys per second, %&#39;uKB RAM&quot;</span><span class="p">,</span> <span class="n">testKeys</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">,</span> <span class="n">rss_size_after</span> <span class="o">-</span> <span class="n">rss_size_before</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">uint32_t</span> <span class="n">keys_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">testKeys</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">testKeys</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                          <span class="n">shf</span><span class="o">-&gt;</span><span class="n">MakeHash</span>     <span class="p">(</span><span class="n">SHF_CAST</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">keys_found</span> <span class="o">+=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetKeyValCopy</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">keys_found</span><span class="p">,</span> <span class="s">&quot;c++: got expected number of non-existing keys // estimate %&#39;.0f keys per second&quot;</span><span class="p">,</span> <span class="n">testKeys</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">uint32_t</span> <span class="n">keys_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testKeys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                          <span class="n">shf</span><span class="o">-&gt;</span><span class="n">MakeHash</span>     <span class="p">(</span><span class="n">SHF_CAST</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">keys_found</span> <span class="o">+=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">GetKeyValCopy</span><span class="p">();</span>
            <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">shf_val_len</span><span class="p">,</span> <span class="s">&quot;INTERNAL: expected shf_val_len to be %lu but got %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">shf_val_len</span><span class="p">);</span>
            <span class="n">SHF_ASSERT</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">shf_val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="s">&quot;INTERNAL: unexpected shf_val</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">testKeys</span> <span class="o">==</span> <span class="n">keys_found</span><span class="p">,</span> <span class="s">&quot;c++: got expected number of     existing keys // estimate %&#39;.0f keys per second&quot;</span><span class="p">,</span> <span class="n">testKeys</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugGetGarbage</span><span class="p">(),</span> <span class="s">&quot;c++: graceful growth cleans up after itself as expected&quot;</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="kt">uint32_t</span> <span class="n">keys_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testKeys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                          <span class="n">shf</span><span class="o">-&gt;</span><span class="n">MakeHash</span> <span class="p">(</span><span class="n">SHF_CAST</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">keys_found</span> <span class="o">+=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DelKeyVal</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">testKeys</span> <span class="o">==</span> <span class="n">keys_found</span><span class="p">,</span> <span class="s">&quot;c++: del expected number of     existing keys // estimate %&#39;.0f keys per second&quot;</span><span class="p">,</span> <span class="n">testKeys</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">ok</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugGetGarbage</span><span class="p">(),</span> <span class="s">&quot;c++: del does not    clean  up after itself as expected&quot;</span><span class="p">);</span>

    <span class="n">testQItems</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
    <span class="n">shf</span><span class="o">-&gt;</span><span class="n">SetDataNeedFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
                   <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="n">ok</span><span class="p">(</span>   <span class="mi">1</span> <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QIsReady</span>          <span class="p">(</span>                                      <span class="p">),</span> <span class="s">&quot;c++: -&gt;QIsReady()     ready as expected&quot;</span><span class="p">);</span>
                   <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QDel</span>              <span class="p">(</span>                                      <span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span>   <span class="mi">0</span> <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QIsReady</span>          <span class="p">(</span>                                      <span class="p">),</span> <span class="s">&quot;c++: -&gt;QIsReady() not ready as expected&quot;</span><span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QNew</span>              <span class="p">(</span><span class="n">testQs</span><span class="p">,</span> <span class="n">testQItems</span><span class="p">,</span> <span class="n">testQItemSize</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="s">&quot;c++: -&gt;QNew()     returned  as expected&quot;</span><span class="p">);</span>
        <span class="n">ok</span><span class="p">(</span>   <span class="mi">1</span> <span class="o">==</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QIsReady</span>          <span class="p">(</span>                                      <span class="p">),</span> <span class="s">&quot;c++: -&gt;QIsReady()     ready as expected&quot;</span><span class="p">);</span>
                   <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;c++: created expected number of new queue items // estimate %&#39;.0f q items per second&quot;</span><span class="p">,</span> <span class="n">testQItems</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPullTail</span><span class="p">(</span><span class="n">testQidFree</span>          <span class="p">))</span> <span class="p">{</span>
                               <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHead</span><span class="p">(</span><span class="n">testQidA2b</span> <span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                               <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: moved   expected number of new queue items // estimate %&#39;.0f q items per second using 2 functions&quot;</span><span class="p">,</span> <span class="n">testQItems</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPullTail</span><span class="p">(</span><span class="n">testQidA2b</span>         <span class="p">))</span> <span class="p">{</span>
                               <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHead</span><span class="p">(</span><span class="n">testQidB2a</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">);</span>
                               <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: moved   expected number of new queue items // estimate %&#39;.0f q items per second using 2 functions&quot;</span><span class="p">,</span> <span class="n">testQItems</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityLess</span><span class="p">();</span>
        <span class="kt">double</span> <span class="n">testStartTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">();</span>
        <span class="n">testPullItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">shf_qiid</span> <span class="o">=</span> <span class="n">SHF_QIID_NONE</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">SHF_QIID_NONE</span> <span class="o">!=</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">QPushHeadPullTail</span><span class="p">(</span><span class="n">testQidFree</span><span class="p">,</span> <span class="n">shf_qiid</span><span class="p">,</span> <span class="n">testQidB2a</span><span class="p">))</span> <span class="p">{</span>
                               <span class="n">testPullItems</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">testElapsedTime</span> <span class="o">=</span> <span class="n">shf_get_time_in_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">testStartTime</span><span class="p">;</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">testQItems</span> <span class="o">==</span> <span class="n">testPullItems</span><span class="p">,</span> <span class="s">&quot;c++: moved   expected number of new queue items // estimate %&#39;.0f q items per second using 1 function&quot;</span><span class="p">,</span> <span class="n">testQItems</span> <span class="o">/</span> <span class="n">testElapsedTime</span><span class="p">);</span>
        <span class="n">shf</span><span class="o">-&gt;</span><span class="n">DebugVerbosityMore</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;c++: -&gt;Del() // size before deletion: %s&quot;</span><span class="p">,</span> <span class="n">shf</span><span class="o">-&gt;</span><span class="n">Del</span><span class="p">());</span>

    <span class="k">delete</span>  <span class="n">shf</span><span class="p">;</span>

    <span class="k">return</span> <span class="nf">exit_status</span><span class="p">();</span>
<span class="p">}</span></div></div></div></div></body></html>